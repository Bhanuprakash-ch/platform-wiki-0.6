Beta version.

# Hybrid installation (OpenStack & bare-metal)
This wiki page describes necessary steps to deploy TAP in a hybrid configuration. Cloud Foundry part is deployed on OpenStack and Hadoop cluster is deployed on bare-metal.

## Prerequisites
 * OpenStack tenant with at least: 100vCPU, 328GB RAM, 1.5TB Storage
 * Total of 9 floating IPs.
 * Additional OpenStack requirements are listed here: https://github.com/trustedanalytics/platform-wiki/wiki/Platform-Deployment-on-OpenStack

### Preparations specific for bare-metal hosts

 * Install **CentOS 6.7** x86_64 on 6 hosts (default layout: 3 workers + 3 masters)
 * Make sure you have sufficient amount of memory and disk space:
  * hdd: 100GB root, 2x >=70GB for data (depends on specific usage)
  * ram: >=16GB 
 * Configure 2 paths for data:
  * there should be separate mountpoints for better performance (ex. /data0 and /data1)
  * if not, may be any dir, but separate for each datapath
  * format with ext3 and mount datapaths (add to /etc/fstab as well)
 * Disable firewall on hosts
 * All nodes should have primary IP address assigned to eth0 device
 * Check network connectivity between hosts
 * Setup working dns and ntp
 * Create 'centos' user and add deployment ssh keys to /home/centos/.ssh/authorized_keys 
 * Verify, that you can login as centos user from cdh-lancher to all CDH nodes with given ssh key
 * Add user centos to sudo without password using visudo command:
```        centos ALL=(ALL) NOPASSWD: ALL```
 * Make sure you have installed ```redhat-lsb-core``` package

## Changes in deployment

There are some changes to the general deployment procedure (refer to: https://github.com/trustedanalytics/platform-wiki/wiki/Platform%20Deployment%20on%20OpenStack#clone-the-repo) as described below.

> After ```make update```

* Set number of workers and masters to 0 in terraform.tfvars  
```worker_size=0 # set worker size you want to have for cloudera```  
```master_size=0 # set master size you want to have for cloudera```   
* edit platform-ansible/bin/run_ansible.sh and comment out last line with exec:   
``` #exec ansible-playbook site.yml -v -i inventory/cdh -f 20 -s```   

> Now you can safely run rest of the deployment starting with ```make apply```.  

> When ```make provision``` is finished you should perform the following changes: 

* Add floating IP in OpenStack to instances: 
 * all consul masters
 * cdh-manager
* Login to cdh-launcher host (IP can be found in Horizon) as centos user using ssh key defined in terraform
* Manually run **provision.sh** with parameters (those in <> are mandatory and those in [] optional):

> ./provision.sh \<CDH-manager-floating-IP\> \<CDH-master-0-IP\>,\<CDH-master-1-IP\>,\<CDH-master-2-IP\>,...,\<CDH-master-N-IP\> \<CDH-worker-0-IP\>,\<CDH-worker-1-IP\>,\<CDH-worker-2-IP\>,...,\<CDH-worker-N-IP\> \<CONSUL-master-0-floating-IP>\,\<CONSUL-master-1-floating-IP\>,\<CONSUL-master-2-floating-IP\> \<NTP-server-1-IP\>,\<NTP-server-2-IP\> [http://your-proxy.com:8080] [http://your-ssl-proxy.com:8443]

* Go to **~/ansible-cdh/platform-ansible/**
* Set proper options at defaults/cdh.yml:
* data paths (configured on bare-metal hosts)
* Check other default settins (as proxy, envname, ntp servers, etc) in defaults/*.yml
* Check if inventory/cdh is set correctly with your hosts. 
* Modify Security Groups in OpenStack: 
 * open access from bare-metal IP class to all already configured SecurityGroups
```
Rule: Other Protocol
Direction: Ingress
IP Protocol: <leave empty>
Remote:  CIDR
CDIR: <your CDH cluster IP addres class in CIDR formt>
```
 * open access from all (0.0.0.0/0) to CDH-* SG
```
Rule: Other Protocol
Direction: Ingress
IP Protocol: <leave empty>
Remote:  CIDR
CDIR: 0.0.0.0/0
```
* Launch bin/bare_metal_install.sh (screen or tmux would help to keep session alive)

> Now Cloudera should be installed in next 2-3h (depends on hosts/network performance)

> Now you are ready to perform next steps from "Set up bosh deployment" section (from standard installation process documentation) to the point where Apps will be pushed. BEFORE pushing apps make sure CDH installation is finished, and below changes are done: 

* Modify CF Security Group
 * execute from bastion:  
``` cf security-group public_networks```  
 * paste output JSON into the new file, and add custom rule with bare-metal IP class, as the last one, ie:  
` {
			"destination": "10.54.0.0/16",
			"protocol": "all"
   }
`
 * apply SG update with:  
``` cf update-security-group public_networks <YOUR FILENAME HERE>```  

* Add routing from CDH to docker vm
  * find docker internal IP. 

     On bastion execute:``` cd ~/workspace/deployments/cf-boshworkspace &&
bosh vms | grep docker ```  
   * assign floating IP to docker vm in OpenStack
   * on all CDH nodes (workers, and masters) setup static routing to docker vm via its floating IP.

     On all nodes execute: ```ip r add <docker.internal.ip> via <docker.floating.ip> ```
   * remember to add static route to configuration files
